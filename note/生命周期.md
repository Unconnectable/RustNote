## [三条消除规则](https://course.rs/basic/lifetime.html#三条消除规则)

编译器使用三条消除规则来确定哪些场景不需要显式地去标注生命周期.其中第一条规则应用在输入生命周期上,第二、三条应用在输出生命周期上.若编译器发现三条规则都不适用时,就会报错,提示你需要手动标注生命周期.

1. **每一个引用参数都会获得独自的生命周期**

   例如一个引用参数的函数就有一个生命周期标注: `fn foo<'a>(x: &'a i32)`,两个引用参数的有两个生命周期标注:`fn foo<'a, 'b>(x: &'a i32, y: &'b i32)`, 依此类推.

2. **若只有一个输入生命周期(函数参数中只有一个引用类型),那么该生命周期会被赋给所有的输出生命周期**,也就是所有返回值的生命周期都等于该输入生命周期

   例如函数 `fn foo(x: &i32) -> &i32`,`x` 参数的生命周期会被自动赋给返回值 `&i32`,因此该函数等同于 `fn foo<'a>(x: &'a i32) -> &'a i32`

3. **若存在多个输入生命周期,且其中一个是 `&self` 或 `&mut self`,则 `&self` 的生命周期被赋给所有的输出生命周期**

   拥有 `&self` 形式的参数,说明该函数是一个 `方法`,该规则让方法的使用便利度大幅提升.

```rust
use std::fmt::Debug; // 特征约束使用

#[derive(Debug)]
struct Ref<'a, T: 'a>(&'a T);
// `Ref` 包含对泛型类型 `T` 的引用,该泛型类型具有
// 未知的生命周期 `'a`. `T` 是约定任何
// 引用在 `T` 必须大于 `'a` .此外,在生命周期
// 里 `Ref` 不能超过 `'a`.

// 使用 `Debug` 特征打印的通用函数.
fn print<T>(t: T) where
    T: Debug {
    println!("`print`: t is {:?}", t);
}

// 这里引用 `T` 使用 where `T` 实现
// `Debug` 和所有引用 `T` 都要比 `'a` 长
// 此外,`'a`必须要比函数声明周期长
fn print_ref<'a, T>(t: &'a T) where
    T: Debug + 'a {
    println!("`print_ref`: t is {:?}", t);
}

fn main() {
    let x = 7;
    let ref_x = Ref(&x);

    print_ref(&ref_x);
    print(ref_x);
}
```

```rust
struct DoubleRef<'a, T: 'a> {
    r: &'a T,
    s: &'a T,
}
fn main() {
    println!("Success!")
}
```

常见的一个问题

```rust
fn longer<'a>(x: &'a str, y: &'a str) -> &'a str {
    if x.len() >y.len(){
        x
    }  //可能二者生命周期不同
    else {
        y
    }
}
```

这个时候有对与生命周期之间的关系有新的要求,
`'a: 'out`表示`'a`的生命周期比`'out`长

```rust
fn longer<'a: 'out, 'b: 'out, 'out>(x: &'a str, y: &'b str) -> &'out str {
    if x.len() >y.len(){
        x
    }  //可能二者生命周期不同
    else {
        y
    }
}
// 一样的写法
fn longer<'a, 'b, 'out>(x: &'a str, y: &'b str) -> &'out str
where
    'a: 'out,
    'b: 'out,
{
    if x.len() > y.len() { x } else { y }
}
```

### HRTB(更高等级特征约束)(Higher-ranked trait bounds) 写法

```rust
/* 添加 HRTB 使下面代码正常运行！ */
fn call_on_ref_zero<F>(f: F)
where
    for<'a> F: Fn(&'a i32),
{
    let zero = 0;
    f(&zero);
}

fn main() {
    println!("Success!")
}
```
